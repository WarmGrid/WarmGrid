---
layout: post
title: 用 Lisp 编写多重剪切板，在不同 AutoCAD 程序间传递文件
tags:
- AutoCAD
- Lisp
- 创作
status: publish
type: post
published: true
meta: {}
---
工作中经常在 AutoCAD 中原位粘贴各种零碎图形，而且会用到许多个 AutoCAD（有时还开一个 CASS），在它们之间交换文件麻烦死了。我想 Windows 中有不少剪切板增强工具，如 ClipX Ditto 之类，都提供多个缓冲位置，可以同时存储不同的文本，按照需要粘贴。AutoCAD 为什么没个类似功能呢？最后我研究了一番 Lisp 做了个简单的多重剪切板工具。

原理很简单，是利用"写块"和"插入块"的功能。使用前需要先配置缓存路径，目前是 "F:/_temp_/" ，可以改成你自己的。完后按 c1 就是将选中对象存到剪切板位置1，按 v1 将其粘贴回来。这个临时图形是存在硬盘的，所以能直接粘贴到另一个进程的 CAD 中。

因为刚接触 Lisp 很多知识不了解，用 cond 函数时被括号内求值顺序卡了半天，最后总算弄明白了……这段很2的注释就不删除了，不知还有没有人遇到类似的问题。
<pre><span style="color:#008000;">;传送当前选择的图形对象，用于在不同文档，不同版本CAD之间转移所选对象</span>
<span style="color:#008000;">;按 x1 c3 v2... 使用</span>
<span style="color:#008000;">; x1 = 所选图形剪贴到缓存位置1</span>
<span style="color:#008000;">; c3 = 所选图形复制到缓存位置3</span>
<span style="color:#008000;">; v2 = 从缓存位置2粘贴回来</span>

<span style="color:#008000;">;让函数名直接表示参数，使操作按键尽可能减少</span>
<span style="color:#008000;">;有更好的办法么？ #unsolved</span>
<span style="color:#0080c0;"><strong>(</strong></span><span style="color:#0000ff;"><strong>defun</strong></span> c:x1 <span style="color:#0080c0;"><strong>()</strong></span> <span style="color:#0080c0;"><strong>(</strong></span> <span style="color:#0000ff;"><strong>setq</strong></span> sss <span style="color:#0080c0;"><strong>(</strong></span> ssget<span style="color:#0080c0;"><strong>))</strong></span> <span style="color:#0080c0;"><strong>(</strong></span>blocktransport <span style="color:#808080;">"x"</span> <span style="color:#808080;">"1"</span> sss<span style="color:#0080c0;"><strong>))</strong></span>
<span style="color:#0080c0;"><strong>(</strong></span><span style="color:#0000ff;"><strong>defun</strong></span> c:x2 <span style="color:#0080c0;"><strong>()</strong></span> <span style="color:#0080c0;"><strong>(</strong></span> <span style="color:#0000ff;"><strong>setq</strong></span> sss <span style="color:#0080c0;"><strong>(</strong></span> ssget<span style="color:#0080c0;"><strong>))</strong></span> <span style="color:#0080c0;"><strong>(</strong></span>blocktransport <span style="color:#808080;">"x"</span> <span style="color:#808080;">"2"</span> sss<span style="color:#0080c0;"><strong>))</strong></span>
<span style="color:#0080c0;"><strong>(</strong></span><span style="color:#0000ff;"><strong>defun</strong></span> c:x3 <span style="color:#0080c0;"><strong>()</strong></span> <span style="color:#0080c0;"><strong>(</strong></span> <span style="color:#0000ff;"><strong>setq</strong></span> sss <span style="color:#0080c0;"><strong>(</strong></span> ssget<span style="color:#0080c0;"><strong>))</strong></span> <span style="color:#0080c0;"><strong>(</strong></span>blocktransport <span style="color:#808080;">"x"</span> <span style="color:#808080;">"3"</span> sss<span style="color:#0080c0;"><strong>))</strong></span>
<span style="color:#0080c0;"><strong>(</strong></span><span style="color:#0000ff;"><strong>defun</strong></span> c:x4 <span style="color:#0080c0;"><strong>()</strong></span> <span style="color:#0080c0;"><strong>(</strong></span> <span style="color:#0000ff;"><strong>setq</strong></span> sss <span style="color:#0080c0;"><strong>(</strong></span> ssget<span style="color:#0080c0;"><strong>))</strong></span> <span style="color:#0080c0;"><strong>(</strong></span>blocktransport <span style="color:#808080;">"x"</span> <span style="color:#808080;">"4"</span> sss<span style="color:#0080c0;"><strong>))</strong></span>
<span style="color:#0080c0;"><strong>(</strong></span><span style="color:#0000ff;"><strong>defun</strong></span> c:x5 <span style="color:#0080c0;"><strong>()</strong></span> <span style="color:#0080c0;"><strong>(</strong></span> <span style="color:#0000ff;"><strong>setq</strong></span> sss <span style="color:#0080c0;"><strong>(</strong></span> ssget<span style="color:#0080c0;"><strong>))</strong></span> <span style="color:#0080c0;"><strong>(</strong></span>blocktransport <span style="color:#808080;">"x"</span> <span style="color:#808080;">"5"</span> sss<span style="color:#0080c0;"><strong>))</strong></span>

<span style="color:#0080c0;"><strong>(</strong></span><span style="color:#0000ff;"><strong>defun</strong></span> c:c1 <span style="color:#0080c0;"><strong>()</strong></span> <span style="color:#0080c0;"><strong>(</strong></span> <span style="color:#0000ff;"><strong>setq</strong></span> sss <span style="color:#0080c0;"><strong>(</strong></span> ssget<span style="color:#0080c0;"><strong>))</strong></span> <span style="color:#0080c0;"><strong>(</strong></span>blocktransport <span style="color:#808080;">"c"</span> <span style="color:#808080;">"1"</span> sss<span style="color:#0080c0;"><strong>))</strong></span>
<span style="color:#0080c0;"><strong>(</strong></span><span style="color:#0000ff;"><strong>defun</strong></span> c:c2 <span style="color:#0080c0;"><strong>()</strong></span> <span style="color:#0080c0;"><strong>(</strong></span> <span style="color:#0000ff;"><strong>setq</strong></span> sss <span style="color:#0080c0;"><strong>(</strong></span> ssget<span style="color:#0080c0;"><strong>))</strong></span> <span style="color:#0080c0;"><strong>(</strong></span>blocktransport <span style="color:#808080;">"c"</span> <span style="color:#808080;">"2"</span> sss<span style="color:#0080c0;"><strong>))</strong></span>
<span style="color:#0080c0;"><strong>(</strong></span><span style="color:#0000ff;"><strong>defun</strong></span> c:c3 <span style="color:#0080c0;"><strong>()</strong></span> <span style="color:#0080c0;"><strong>(</strong></span> <span style="color:#0000ff;"><strong>setq</strong></span> sss <span style="color:#0080c0;"><strong>(</strong></span> ssget<span style="color:#0080c0;"><strong>))</strong></span> <span style="color:#0080c0;"><strong>(</strong></span>blocktransport <span style="color:#808080;">"c"</span> <span style="color:#808080;">"3"</span> sss<span style="color:#0080c0;"><strong>))</strong></span>
<span style="color:#0080c0;"><strong>(</strong></span><span style="color:#0000ff;"><strong>defun</strong></span> c:c4 <span style="color:#0080c0;"><strong>()</strong></span> <span style="color:#0080c0;"><strong>(</strong></span> <span style="color:#0000ff;"><strong>setq</strong></span> sss <span style="color:#0080c0;"><strong>(</strong></span> ssget<span style="color:#0080c0;"><strong>))</strong></span> <span style="color:#0080c0;"><strong>(</strong></span>blocktransport <span style="color:#808080;">"c"</span> <span style="color:#808080;">"4"</span> sss<span style="color:#0080c0;"><strong>))</strong></span>
<span style="color:#0080c0;"><strong>(</strong></span><span style="color:#0000ff;"><strong>defun</strong></span> c:c5 <span style="color:#0080c0;"><strong>()</strong></span> <span style="color:#0080c0;"><strong>(</strong></span> <span style="color:#0000ff;"><strong>setq</strong></span> sss <span style="color:#0080c0;"><strong>(</strong></span> ssget<span style="color:#0080c0;"><strong>))</strong></span> <span style="color:#0080c0;"><strong>(</strong></span>blocktransport <span style="color:#808080;">"c"</span> <span style="color:#808080;">"5"</span> sss<span style="color:#0080c0;"><strong>))</strong></span>

<span style="color:#0080c0;"><strong>(</strong></span><span style="color:#0000ff;"><strong>defun</strong></span> c:v1 <span style="color:#0080c0;"><strong>()</strong></span> <span style="color:#0080c0;"><strong>(</strong></span> <span style="color:#0000ff;"><strong>setq</strong></span> sss <span style="color:#0000ff;"><strong>nil</strong></span> <span style="color:#0080c0;"><strong>)</strong></span>     <span style="color:#0080c0;"><strong>(</strong></span>blocktransport <span style="color:#808080;">"v"</span> <span style="color:#808080;">"1"</span> sss<span style="color:#0080c0;"><strong>))</strong></span>
<span style="color:#0080c0;"><strong>(</strong></span><span style="color:#0000ff;"><strong>defun</strong></span> c:v2 <span style="color:#0080c0;"><strong>()</strong></span> <span style="color:#0080c0;"><strong>(</strong></span> <span style="color:#0000ff;"><strong>setq</strong></span> sss <span style="color:#0000ff;"><strong>nil</strong></span> <span style="color:#0080c0;"><strong>)</strong></span>     <span style="color:#0080c0;"><strong>(</strong></span>blocktransport <span style="color:#808080;">"v"</span> <span style="color:#808080;">"2"</span> sss<span style="color:#0080c0;"><strong>))</strong></span>
<span style="color:#0080c0;"><strong>(</strong></span><span style="color:#0000ff;"><strong>defun</strong></span> c:v3 <span style="color:#0080c0;"><strong>()</strong></span> <span style="color:#0080c0;"><strong>(</strong></span> <span style="color:#0000ff;"><strong>setq</strong></span> sss <span style="color:#0000ff;"><strong>nil</strong></span> <span style="color:#0080c0;"><strong>)</strong></span>     <span style="color:#0080c0;"><strong>(</strong></span>blocktransport <span style="color:#808080;">"v"</span> <span style="color:#808080;">"3"</span> sss<span style="color:#0080c0;"><strong>))</strong></span>
<span style="color:#0080c0;"><strong>(</strong></span><span style="color:#0000ff;"><strong>defun</strong></span> c:v4 <span style="color:#0080c0;"><strong>()</strong></span> <span style="color:#0080c0;"><strong>(</strong></span> <span style="color:#0000ff;"><strong>setq</strong></span> sss <span style="color:#0000ff;"><strong>nil</strong></span> <span style="color:#0080c0;"><strong>)</strong></span>     <span style="color:#0080c0;"><strong>(</strong></span>blocktransport <span style="color:#808080;">"v"</span> <span style="color:#808080;">"4"</span> sss<span style="color:#0080c0;"><strong>))</strong></span>
<span style="color:#0080c0;"><strong>(</strong></span><span style="color:#0000ff;"><strong>defun</strong></span> c:v5 <span style="color:#0080c0;"><strong>()</strong></span> <span style="color:#0080c0;"><strong>(</strong></span> <span style="color:#0000ff;"><strong>setq</strong></span> sss <span style="color:#0000ff;"><strong>nil</strong></span> <span style="color:#0080c0;"><strong>)</strong></span>     <span style="color:#0080c0;"><strong>(</strong></span>blocktransport <span style="color:#808080;">"v"</span> <span style="color:#808080;">"5"</span> sss<span style="color:#0080c0;"><strong>))</strong></span>

<span style="color:#0080c0;"><strong>(</strong></span><span style="color:#0000ff;"><strong>defun</strong></span> blocktransport <span style="color:#0080c0;"><strong>(</strong></span> method num sss <span style="color:#0000ff;"><strong>/</strong></span> p n fn info <span style="color:#0080c0;"><strong>)</strong></span>
<span style="color:#0080c0;"><strong>(</strong></span>setvar <span style="color:#808080;">"filedia"</span> <span style="color:#ff8000;">0</span> <span style="color:#0080c0;"><strong>)</strong></span>
<span style="color:#0080c0;"><strong>(</strong></span>setvar <span style="color:#808080;">"cmdecho"</span> <span style="color:#ff8000;">0</span> <span style="color:#0080c0;"><strong>)</strong></span>
<span style="color:#0080c0;"><strong>(</strong></span>setvar <span style="color:#808080;">"insunits"</span> <span style="color:#ff8000;">0</span> <span style="color:#0080c0;"><strong>)</strong></span>
<span style="color:#0080c0;"><strong>(</strong></span><span style="color:#0000ff;"><strong>setq</strong></span> p <span style="color:#808080;">"f:/_temp_/"</span><span style="color:#0080c0;"><strong>)</strong></span> <span style="color:#008000;">;在这里配置缓存路径，使用斜杠（而不是反斜杠）</span>
<span style="color:#0080c0;"><strong>(</strong></span><span style="color:#0000ff;"><strong>setq</strong></span> n <span style="color:#808080;">"_slot_"</span><span style="color:#0080c0;"><strong>)</strong></span> <span style="color:#008000;">;缓存文件名称，起名应该尽量诡异</span>
<span style="color:#0080c0;"><strong>(</strong></span><span style="color:#0000ff;"><strong>setq</strong></span> fn <span style="color:#0080c0;"><strong>(</strong></span>strcat p n num <span style="color:#808080;">".dwg"</span><span style="color:#0080c0;"><strong>))</strong></span>
<span style="color:#0080c0;"><strong>(</strong></span><span style="color:#0000ff;"><strong>setq</strong></span> info <span style="color:#808080;">""</span><span style="color:#0080c0;"><strong>)</strong></span> <span style="color:#008000;">;成功后输出信息</span>
<span style="color:#0080c0;"><strong>(</strong></span><span style="color:#0000ff;"><strong>setq</strong></span> fn_rnd <span style="color:#0080c0;"><strong>(</strong></span>strcat p <span style="color:#808080;">"back_"</span> <span style="color:#0080c0;"><strong>(</strong></span> rtos <span style="color:#0080c0;"><strong>(</strong></span>getvar <span style="color:#808080;">"cdate"</span><span style="color:#0080c0;"><strong>)</strong></span> <span style="color:#ff8000;">2</span> <span style="color:#ff8000;">8</span> <span style="color:#0080c0;"><strong>)</strong></span> <span style="color:#808080;">".dwg"</span><span style="color:#0080c0;"><strong>))</strong></span>

<span style="color:#008000;">;这个 condition 明显是"点对"啊，</span>
<span style="color:#008000;">;为什么 (cond ( (= method "x") (bla...) (bla...) (bla...) ) 是对的</span>
<span style="color:#008000;">;而 后面那一堆括起来 (cond ( (= method "x") ((bla...) (bla...) (bla...)) ) 是错的？</span>
<span style="color:#008000;">;发现 (cond ((= 1 1) (alert "22") )) 没问题</span>
<span style="color:#008000;">;发现 (cond ((= 1 1) (alert "22") (alert "33"))) 也没问题</span>
<span style="color:#008000;">;但括起来后面的那堆 (cond ((= 1 1) ((alert "22") (alert "33")))) 却会先弹窗 33 ，从右向左！</span>
<span style="color:#008000;">;这什么破玩意</span>
<span style="color:#008000;">;发现((bla1) (bla2) (bla3)) 都是从右向左的</span>
<span style="color:#008000;">;也不尽然 括起来后，下面那些 (alert "1") - (alert "4") 顺序是 2 3 4 1</span>
<span style="color:#008000;">;不括起来，下面那些 (alert "1") - (alert "4") 顺序是 1 2 3 4</span>
<span style="color:#008000;">;也就是说 括起来后，()中第一个被视为函数，所以先求实参了？</span>
<span style="color:#008000;">;先加个 list 就可以括起来了 (list () () () bla1 bla2 bla3 blabla)</span>
<span style="color:#0080c0;"><strong>(</strong></span><span style="color:#0000ff;"><strong>cond</strong></span>
<span style="color:#0080c0;"><strong>((</strong></span><span style="color:#0000ff;"><strong>=</strong></span> method <span style="color:#808080;">"x"</span><span style="color:#0080c0;"><strong>)</strong></span> <span style="color:#008000;">;剪切图形 to slot</span>
<span style="color:#0080c0;"><strong>(</strong></span><span style="color:#0000ff;"><strong>list</strong></span> <span style="color:#008000;">;使用 list 串联表</span>
<span style="color:#008000;">;(alert "1")</span>
<span style="color:#0080c0;"><strong>(</strong></span><span style="color:#0000ff;"><strong>cond</strong></span> <span style="color:#0080c0;"><strong>((</strong></span>findfile fn<span style="color:#0080c0;"><strong>)</strong></span> <span style="color:#0080c0;"><strong>(</strong></span>command <span style="color:#808080;">"-wblock"</span> fn <span style="color:#808080;">"y"</span> <span style="color:#808080;">""</span> <span style="color:#808080;">"0,0"</span> sss <span style="color:#808080;">""</span> <span style="color:#0080c0;"><strong>))</strong></span>
<span style="color:#0080c0;"><strong>('</strong></span><span style="color:#000080;"><strong>t</strong></span> <span style="color:#0080c0;"><strong>(</strong></span>command <span style="color:#808080;">"-wblock"</span> fn <span style="color:#808080;">""</span> <span style="color:#808080;">"0,0"</span> sss <span style="color:#808080;">""</span> <span style="color:#0080c0;"><strong>))</strong></span>
<span style="color:#0080c0;"><strong>)</strong></span>
<span style="color:#008000;">;(alert "2")</span>
<span style="color:#0080c0;"><strong>(</strong></span>command <span style="color:#808080;">"oops"</span> <span style="color:#0080c0;"><strong>)</strong></span> <span style="color:#0080c0;"><strong>(</strong></span> command <span style="color:#808080;">"-wblock"</span> fn_rnd <span style="color:#808080;">""</span> <span style="color:#808080;">"0,0"</span> sss <span style="color:#808080;">""</span><span style="color:#0080c0;"><strong>)</strong></span> <span style="color:#008000;">;备份唯一名称的图块</span>
<span style="color:#0080c0;"><strong>(</strong></span><span style="color:#0000ff;"><strong>setq</strong></span> info <span style="color:#0080c0;"><strong>(</strong></span>strcat <span style="color:#808080;">"*cut* to slot"</span> num <span style="color:#808080;">" done !"</span><span style="color:#0080c0;"><strong>))</strong></span>
<span style="color:#008000;">;(alert "3")</span>
<span style="color:#008000;">;(alert "4")</span>
<span style="color:#0080c0;"><strong>)</strong></span>
<span style="color:#0080c0;"><strong>)</strong></span>

<span style="color:#0080c0;"><strong>((</strong></span><span style="color:#0000ff;"><strong>=</strong></span> method <span style="color:#808080;">"c"</span><span style="color:#0080c0;"><strong>)</strong></span> <span style="color:#008000;">;复制图形 to slot</span>
<span style="color:#008000;">;不使用 list 串联表，依次计算零散的分支</span>
<span style="color:#0080c0;"><strong>(</strong></span><span style="color:#0000ff;"><strong>cond</strong></span> <span style="color:#0080c0;"><strong>((</strong></span>findfile fn<span style="color:#0080c0;"><strong>)</strong></span> <span style="color:#0080c0;"><strong>(</strong></span>command <span style="color:#808080;">"-wblock"</span> fn <span style="color:#808080;">"y"</span> <span style="color:#808080;">""</span> <span style="color:#808080;">"0,0"</span> sss <span style="color:#808080;">""</span> <span style="color:#0080c0;"><strong>))</strong></span>
<span style="color:#0080c0;"><strong>('</strong></span><span style="color:#000080;"><strong>t</strong></span> <span style="color:#0080c0;"><strong>(</strong></span>command <span style="color:#808080;">"-wblock"</span> fn <span style="color:#808080;">""</span> <span style="color:#808080;">"0,0"</span> sss <span style="color:#808080;">""</span> <span style="color:#0080c0;"><strong>))</strong></span>
<span style="color:#0080c0;"><strong>)</strong></span>
<span style="color:#0080c0;"><strong>(</strong></span>command <span style="color:#808080;">"oops"</span> <span style="color:#0080c0;"><strong>)</strong></span> <span style="color:#0080c0;"><strong>(</strong></span> command <span style="color:#808080;">"-wblock"</span> fn_rnd <span style="color:#808080;">""</span> <span style="color:#808080;">"0,0"</span> sss <span style="color:#808080;">""</span><span style="color:#0080c0;"><strong>)</strong></span> <span style="color:#008000;">;备份唯一名称的图块</span>
<span style="color:#0080c0;"><strong>(</strong></span>command <span style="color:#808080;">"oops"</span> <span style="color:#0080c0;"><strong>)</strong></span> <span style="color:#008000;">;写块时会从原图清掉这些图形，需要还原回来</span>

<span style="color:#0080c0;"><strong>(</strong></span><span style="color:#0000ff;"><strong>setq</strong></span> info <span style="color:#0080c0;"><strong>(</strong></span>strcat <span style="color:#808080;">"*copy* to slot"</span> num <span style="color:#808080;">" done !"</span><span style="color:#0080c0;"><strong>))</strong></span>
<span style="color:#0080c0;"><strong>)</strong></span>

<span style="color:#0080c0;"><strong>((</strong></span><span style="color:#0000ff;"><strong>=</strong></span> method <span style="color:#808080;">"v"</span><span style="color:#0080c0;"><strong>)</strong></span> <span style="color:#008000;">;粘贴图形 from slot</span>
<span style="color:#0080c0;"><strong>(</strong></span>command <span style="color:#808080;">"_insert"</span> fn <span style="color:#808080;">"0,0"</span> <span style="color:#808080;">"1"</span> <span style="color:#808080;">"1"</span> <span style="color:#808080;">"0"</span><span style="color:#0080c0;"><strong>)</strong></span>
<span style="color:#0080c0;"><strong>(</strong></span><span style="color:#0000ff;"><strong>setq</strong></span> ss <span style="color:#0080c0;"><strong>(</strong></span>entlast<span style="color:#0080c0;"><strong>))</strong></span>
<span style="color:#0080c0;"><strong>(</strong></span>command <span style="color:#808080;">"_explode"</span> ss<span style="color:#0080c0;"><strong>)</strong></span> <span style="color:#008000;">;炸开图块</span>
<span style="color:#0080c0;"><strong>(</strong></span>command <span style="color:#808080;">"-purge"</span> <span style="color:#808080;">"b"</span> <span style="color:#0080c0;"><strong>(</strong></span>strcat n num<span style="color:#0080c0;"><strong>)</strong></span> <span style="color:#808080;">"y"</span> <span style="color:#808080;">"y"</span><span style="color:#0080c0;"><strong>)</strong></span> <span style="color:#008000;">;清理掉这个块的定义</span>
<span style="color:#0080c0;"><strong>(</strong></span><span style="color:#0000ff;"><strong>setq</strong></span> info <span style="color:#0080c0;"><strong>(</strong></span>strcat <span style="color:#808080;">"*paste* slot"</span> num <span style="color:#808080;">" done !"</span><span style="color:#0080c0;"><strong>))</strong></span>
<span style="color:#0080c0;"><strong>)</strong></span>

<span style="color:#0080c0;"><strong>)</strong></span>
<span style="color:#0080c0;"><strong>(</strong></span>setvar <span style="color:#808080;">"cmdecho"</span> <span style="color:#ff8000;">1</span> <span style="color:#0080c0;"><strong>)</strong></span>
<span style="color:#0080c0;"><strong>(</strong></span>setvar <span style="color:#808080;">"filedia"</span> <span style="color:#ff8000;">1</span> <span style="color:#0080c0;"><strong>)</strong></span>
<span style="color:#0080c0;"><strong>(</strong></span>prompt info <span style="color:#0080c0;"><strong>)</strong></span>
<span style="color:#0080c0;"><strong>)</strong></span></pre>
完
